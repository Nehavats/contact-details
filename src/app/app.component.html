<div class="container">
 

  <header>
    <h1></h1>
    <div class="control-row">
      <label class="row">
        <span class="muted">Layout</span>
        <!-- IMPORTANT: fire ngModelChange to push into BehaviorSubject -->
        <select
          class="select"
          [(ngModel)]="activeKey"
          (ngModelChange)="onKeyChange($event)"
        >
          <option 
            *ngFor="let layoutKey of (layoutKeys$ | async)"
            [value]="layoutKey"
          >
            {{ getLayoutDisplayName(layoutKey) }}
          </option>
        </select>
      </label>
    </div>
  </header>

  <!-- The layout now updates when activeKey changes -->
  <div class="layout" *ngIf="layout$ | async as layout">
    <!-- LEFT column -->
    <section class="col">
      <ng-container *ngFor="let s of layout.columns[0]?.sections">
        <contact-details *ngIf="s.key==='contactDetails'" [layoutKey]="activeKey"></contact-details>
        <conversations-panel
          *ngIf="s.key === 'conversations'"
          [items]="(conversations$ | async) || []"
        ></conversations-panel>
        <notes-panel
          *ngIf="s.key === 'notes'"
          [items]="(notes$ | async) || []"
        ></notes-panel>
        <tasks-panel
          *ngIf="s.key === 'tasks'"
          [items]="(tasks$ | async) || []"
        ></tasks-panel>
      </ng-container>
    </section>

    <!-- MIDDLE column -->
    <section class="col">
      <ng-container *ngFor="let s of layout.columns[1]?.sections">
        <contact-details *ngIf="s.key==='contactDetails'" [layoutKey]="activeKey"></contact-details>
        <conversations-panel
          *ngIf="s.key === 'conversations'"
          [items]="(conversations$ | async) || []"
        ></conversations-panel>
        <notes-panel
          *ngIf="s.key === 'notes'"
          [items]="(notes$ | async) || []"
        ></notes-panel>
        <tasks-panel
          *ngIf="s.key === 'tasks'"
          [items]="(tasks$ | async) || []"
        ></tasks-panel>
      </ng-container>
    </section>

    <!-- RIGHT column -->
    <section class="col">
      <ng-container *ngFor="let s of layout.columns[2]?.sections">
        <contact-details *ngIf="s.key==='contactDetails'" [layoutKey]="activeKey"></contact-details>
        <conversations-panel
          *ngIf="s.key === 'conversations'"
          [items]="(conversations$ | async) || []"
        ></conversations-panel>
        <notes-panel
          *ngIf="s.key === 'notes'"
          [items]="(notes$ | async) || []"
        ></notes-panel>
        <tasks-panel
          *ngIf="s.key === 'tasks'"
          [items]="(tasks$ | async) || []"
        ></tasks-panel>
      </ng-container>
    </section>
  </div>
</div>